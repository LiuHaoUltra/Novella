name: Build Unsigned IPA

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  push:
    branches: ["main", "master"]
    paths:
      - 'lib/**'
      - 'ios/**'
      - 'rust/**'
      - 'pubspec.yaml'
      - '.github/workflows/build_ipa.yml'

jobs:
  build-ipa:
    name: Build iOS IPA
    runs-on: macos-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. é…ç½® Rust ç¯å¢ƒ
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      # 2. é…ç½® Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'master'
          cache: true

      # 3. ç¼–è¯‘ Rust å¹¶æ”¾å…¥æŒ‡å®šç›®å½•
      - name: Build and Place Rust Lib
        run: |
          echo "ğŸ› ï¸ Compiling Rust for iOS..."
          cd rust
          cargo build --release --target aarch64-apple-ios
          cd ..
          
          echo "ğŸ“‚ Moving lib to ios/Libs..."
          mkdir -p ios/Libs
          cp rust/target/aarch64-apple-ios/release/libnovella_native.a ios/Libs/
          
          echo "âœ… Rust lib placed successfully!"

      # 4. è·å–ä¾èµ–
      - name: Flutter Pub Get
        run: flutter pub get

      # 5. [è°ƒè¯•æ­¥éª¤] éªŒè¯å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      # å¾ˆå¤šæ—¶å€™æ˜¯å› ä¸º Xcode æ‰¾ä¸åˆ°è¿™ä¸ªæ–‡ä»¶ï¼Œå¯¼è‡´é“¾æ¥å¤±è´¥ï¼Œç„¶å Flutter è¯¯æŠ¥ä¸ºç­¾åé”™è¯¯
      - name: Debug - Check File Existence
        run: |
          echo "ğŸ” Checking ios directory structure..."
          ls -R ios/Libs
          echo "PWD is: $(pwd)"

      # 6. æš´åŠ›ç§»é™¤ç­¾åé…ç½® (ä¿ç•™è¿™ä¸ªæ­¥éª¤ï¼Œå› ä¸ºå®ƒä»ç„¶æ˜¯å¿…é¡»çš„)
      - name: Nuke Code Signing
        run: |
          echo "â˜¢ï¸ Nuking code signing configurations..."
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]" = "iPhone Developer";/"CODE_SIGN_IDENTITY[sdk=iphoneos*]" = "";/g' ios/Runner.xcodeproj/project.pbxproj
          echo "CODE_SIGNING_ALLOWED = NO" >> ios/Flutter/Release.xcconfig
          echo "CODE_SIGNING_REQUIRED = NO" >> ios/Flutter/Release.xcconfig
          echo "CODE_SIGN_IDENTITY =" >> ios/Flutter/Release.xcconfig
          echo "CODE_SIGN_STYLE = Manual" >> ios/Flutter/Release.xcconfig

      # 7. [å…³é”®ä¿®æ”¹] æ„å»ºå…ç­¾ Release åŒ… (å¼€å¯ --verbose)
      # åŠ ä¸Š --verbose åï¼Œè¯·ä»”ç»†æ£€æŸ¥ CI æ—¥å¿—ä¸­çº¢è‰²çš„ ERROR éƒ¨åˆ†ï¼Œ
      # çœŸæ­£çš„é”™è¯¯é€šå¸¸éšè—åœ¨ "Requires a selected Development Team" ä¸Šæ–¹å‡ åè¡Œçš„åœ°æ–¹ã€‚
      - name: Build iOS Release (No Codesign)
        run: flutter build ios --release --no-codesign --verbose

      # 8. æ‰“åŒ…æˆ IPA
      - name: Package IPA
        run: |
          mkdir Payload
          mv build/ios/iphoneos/Runner.app Payload
          zip -r novella.ipa Payload

      # 9. ä¸Šä¼ äº§ç‰©
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: novella-unsigned-ipa
          path: novella.ipa
