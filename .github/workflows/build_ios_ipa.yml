name: Build Unsigned IPA

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  push:
    branches: ["main", "master"]
    paths:
      - 'lib/**'
      - 'ios/**'
      - 'rust/**'
      - 'pubspec.yaml'
      - '.github/workflows/build_ipa.yml'

jobs:
  build-ipa:
    name: Build iOS IPA
    runs-on: macos-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. é…ç½® Rust ç¯å¢ƒ
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      # 2. é…ç½® Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          # flutter-version: '3.27.1'
          channel: 'master'
          cache: true

      # 3. ç¼–è¯‘ Rust å¹¶æ”¾å…¥æŒ‡å®šç›®å½•
      - name: Build and Place Rust Lib
        run: |
          echo "ğŸ› ï¸ Compiling Rust for iOS..."
          cd rust
          cargo build --release --target aarch64-apple-ios
          cd ..
          
          echo "ğŸ“‚ Moving lib to ios/Libs..."
          mkdir -p ios/Libs
          cp rust/target/aarch64-apple-ios/release/libnovella_native.a ios/Libs/
          
          echo "âœ… Rust lib placed successfully!"

      # 4. è·å–ä¾èµ–
      - name: Flutter Pub Get
        run: flutter pub get

      # [æ ¸å¿ƒä¿®å¤æ­¥éª¤] 5. æš´åŠ›ç§»é™¤ç­¾åé™åˆ¶
      # ä½¿ç”¨ sed å‘½ä»¤ç›´æ¥ä¿®æ”¹æ–‡ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
      - name: Nuke Code Signing
        run: |
          echo "â˜¢ï¸ Nuking code signing configurations..."
          
          # 1. é’ˆå¯¹ project.pbxproj çš„æš´åŠ›ä¿®æ”¹
          # å°†æ‰€æœ‰ "CODE_SIGN_STYLE = Automatic;" æ›¿æ¢ä¸º "CODE_SIGN_STYLE = Manual;"
          # è¿™ä¸€æ­¥è‡³å…³é‡è¦ï¼Œä¸æ”¹ Manualï¼ŒXcode ä»ä¼šæ£€æŸ¥ Team
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' ios/Runner.xcodeproj/project.pbxproj
          
          # å°†æ‰€æœ‰ "iPhone Developer" ç­¾åèº«ä»½æ›¿æ¢ä¸ºç©º
          sed -i '' 's/"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]" = "iPhone Developer";/"CODE_SIGN_IDENTITY[sdk=iphoneos*]" = "";/g' ios/Runner.xcodeproj/project.pbxproj
          
          # 2. é’ˆå¯¹ Release.xcconfig çš„è¦†ç›–ä¿®æ”¹
          echo "CODE_SIGNING_ALLOWED = NO" >> ios/Flutter/Release.xcconfig
          echo "CODE_SIGNING_REQUIRED = NO" >> ios/Flutter/Release.xcconfig
          echo "CODE_SIGN_IDENTITY =" >> ios/Flutter/Release.xcconfig
          echo "CODE_SIGN_STYLE = Manual" >> ios/Flutter/Release.xcconfig
          
          echo "âœ… Code signing configurations nuked."

      # 6. æ„å»ºå…ç­¾ Release åŒ…
      - name: Build iOS Release (No Codesign)
        run: flutter build ios --release --no-codesign

      # 7. æ‰“åŒ…æˆ IPA
      - name: Package IPA
        run: |
          mkdir Payload
          mv build/ios/iphoneos/Runner.app Payload
          zip -r novella.ipa Payload

      # 8. ä¸Šä¼ äº§ç‰©
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: novella-unsigned-ipa
          path: novella.ipa
