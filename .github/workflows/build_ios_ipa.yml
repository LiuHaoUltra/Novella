name: Build Unsigned IPA

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  push:
    branches: ["main", "master"]
    paths:
      - 'lib/**'
      - 'ios/**'
      - 'rust/**'
      - 'pubspec.yaml'
      - '.github/workflows/build_ipa.yml'

jobs:
  build-ipa:
    name: Build iOS IPA
    runs-on: macos-15
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 0. é€‰æ‹© Xcode 26 (æ”¯æŒ iOS 26 SDK çš„ Liquid Glass API)
      - name: Select Xcode 26
        run: sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer

      # 1. é…ç½® Rust ç¯å¢ƒ
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      # 2. é…ç½® Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'master'
          cache: true

      # 3. ç¼–è¯‘ Rust å¹¶æ”¾å…¥æŒ‡å®šç›®å½•
      - name: Build and Place Rust Lib
        run: |
          echo "ğŸ› ï¸ Compiling Rust for iOS..."
          cd rust
          cargo build --release --target aarch64-apple-ios
          cd ..
          
          echo "ğŸ“‚ Moving lib to ios/libs..."
          mkdir -p ios/libs
          cp rust/target/aarch64-apple-ios/release/libnovella_native.a ios/libs/
          
          echo "âœ… Rust lib placed successfully!"

      # 4. è·å–ä¾èµ–
      - name: Flutter Pub Get
        run: flutter pub get

      # [æ–°å¢æ­¥éª¤] 5. æ˜¾å¼å®‰è£… Pods
      # å¿…é¡»å…ˆç”Ÿæˆ Pods é¡¹ç›®ï¼Œæˆ‘ä»¬æ‰èƒ½åœ¨ä¸‹ä¸€æ­¥ä¿®æ”¹å®ƒçš„ç­¾åé…ç½®
      - name: Install CocoaPods Dependencies
        run: |
          cd ios
          pod install
          cd ..

      # [å…³é”®ä¿®å¤] 6. å…¨å±€æš´åŠ›ç§»é™¤ç­¾åé…ç½® (Runner + Pods)
      # è¿™æ˜¯è§£å†³ "PhaseScriptExecution failed" çš„å…³é”®
      - name: Nuke Code Signing
        run: |
          echo "â˜¢ï¸ Nuking code signing configurations..."
          
          # --- 1. å¤„ç† Runner é¡¹ç›® ---
          echo "   -> Patching Runner.xcodeproj..."
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' ios/Runner.xcodeproj/project.pbxproj
          sed -i '' 's/"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]" = "iPhone Developer";/"CODE_SIGN_IDENTITY[sdk=iphoneos*]" = "";/g' ios/Runner.xcodeproj/project.pbxproj
          
          # --- 2. å¤„ç† Pods é¡¹ç›® (è¿™æ˜¯ä¹‹å‰æ¼æ‰çš„!) ---
          echo "   -> Patching Pods.xcodeproj..."
          # å°† Pods é¡¹ç›®ä¸­çš„æ‰€æœ‰ç­¾åè¦æ±‚å¼ºåˆ¶æ”¹ä¸º Manual å’Œ ç©º
          sed -i '' 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' ios/Pods/Pods.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Developer";/CODE_SIGN_IDENTITY = "";/g' ios/Pods/Pods.xcodeproj/project.pbxproj
          sed -i '' 's/"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]" = "iPhone Developer";/"CODE_SIGN_IDENTITY[sdk=iphoneos*]" = "";/g' ios/Pods/Pods.xcodeproj/project.pbxproj

          # --- 3. å¤„ç† xcconfig (åŒé‡ä¿é™©) ---
          echo "   -> Patching Release.xcconfig..."
          echo "CODE_SIGNING_ALLOWED = NO" >> ios/Flutter/Release.xcconfig
          echo "CODE_SIGNING_REQUIRED = NO" >> ios/Flutter/Release.xcconfig
          echo "CODE_SIGN_IDENTITY =" >> ios/Flutter/Release.xcconfig
          echo "CODE_SIGN_STYLE = Manual" >> ios/Flutter/Release.xcconfig
          
          echo "âœ… Code signing configurations nuked for EVERYTHING."

      # 7. æ„å»ºå…ç­¾ Release åŒ… (ä¿æŒ --verbose ä»¥ä¾¿æ’æŸ¥ï¼Œå¦‚æœæˆåŠŸå¯å»æ‰)
      - name: Build iOS Release (No Codesign)
        run: flutter build ios --release --no-codesign --verbose

      # 8. æ‰“åŒ…æˆ IPA
      - name: Package IPA
        run: |
          mkdir Payload
          mv build/ios/iphoneos/Runner.app Payload
          zip -r novella.ipa Payload

      # 9. ä¸Šä¼ äº§ç‰©
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: novella-unsigned-ipa
          path: novella.ipa
