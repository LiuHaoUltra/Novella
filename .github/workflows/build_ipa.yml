name: Build iOS IPA

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-ios:
    name: Build iOS
    runs-on: macos-latest # 使用 Mac 虚拟机

    steps:
      - uses: actions/checkout@v3

      # 1. 安装 Rust 工具链
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios x86_64-apple-ios

      # 2. 安装 Flutter
      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.0' # 建议固定一个版本
          channel: 'stable'

      # 3. 安装代码生成工具 (FRB)
      - name: Install Codegen
        run: cargo install flutter_rust_bridge_codegen

      # 4. 恢复依赖
      - name: Flutter Pub Get
        run: flutter pub get

      # 5. [关键] 在云端重新生成胶水代码
      # 自动修补 Xcode 工程，编译 Rust
      - name: Generate Rust Bridge
        run: flutter_rust_bridge_codegen generate

      # 6. 构建 IPA (自动调用 Xcode 和 Cargo)
      - name: Build IPA
        run: flutter build ipa --release --no-codesign
        # 注意：正式发布需要配置证书 (p12/mobileprovision)，否则只能生成 .xcarchive
        # 如果只需要验证编译通过，用 --no-codesign 即可

      # 7. 上传产物
      - name: Upload IPA
        uses: actions/upload-artifact@v3
        with:
          name: ios-build
          path: build/ios/ipa/*.ipa